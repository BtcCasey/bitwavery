<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BTC SINGULARITY: RADAR v2</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background: #010208; font-family: 'Press Start 2P', cursive; color: #fff; }
        #ui-main { position: absolute; top: 25px; left: 25px; z-index: 100; background: rgba(0,0,0,0.9); padding: 18px; border: 2px solid #5e43f3; }
        #view-toggle { position: absolute; top: 25px; right: 25px; z-index: 100; background: #5e43f3; color: #fff; border: 4px solid #fff; padding: 10px; cursor: pointer; font-family: 'Press Start 2P'; font-size: 10px; }
        #price { font-size: 18px; color: #fff; margin: 0; }
        #status { font-size: 7px; margin-top: 10px; color: #00ffcc; text-transform: uppercase; }
        canvas { display: block; image-rendering: pixelated; width: 100vw; height: 100vh; }
    </style>
</head>
<body>

<button id="view-toggle">GO TO RADAR</button>
<div id="ui-main">
    <div id="view-label" style="font-size: 8px; color: #5e43f3; margin-bottom: 8px;">SIGNAL: AUTO-SCAN</div>
    <h1 id="price">SCANNING...</h1>
    <div id="status">BYPASSING FIREWALL...</div>
</div>
<canvas id="screen"></canvas>

<script>
    const canvas = document.getElementById('screen');
    const ctx = canvas.getContext('2d');
    const priceDisplay = document.getElementById('price');
    const statusDisplay = document.getElementById('status');
    const viewToggle = document.getElementById('view-toggle');

    const RES_W = 480; const RES_H = 270;
    canvas.width = RES_W; canvas.height = RES_H;

    let currentView = 'singularity';
    let btcPrice = 0, lastPrice = 0;
    let asks = [], bids = [];
    let effects = [];
    let trail = []; // The Comet Tail
    let stars = Array.from({length: 40}, () => ({ x: Math.random()*RES_W, y: Math.random()*RES_H, v: 0.3+Math.random()*0.5 }));

    // --- EFFECT CLASSES ---
    class PulsarWave { constructor() { this.r = 10; this.life = 1.0; } update() { this.r += 3.5; this.life -= 0.02; } draw() { ctx.strokeStyle = `rgba(255,255,255,${this.life})`; ctx.beginPath(); ctx.arc(RES_W/2, RES_H/2, this.r, 0, Math.PI*2); ctx.stroke(); } }

    // --- LIVE DATA ENGINE (COINBASE BYPASS) ---
    function initLive() {
        const ws = new WebSocket('wss://ws-feed.exchange.coinbase.com');
        ws.onopen = () => {
            ws.send(JSON.stringify({
                type: "subscribe",
                channels: [{ name: "ticker", product_ids: ["BTC-USD"] }, { name: "level2", product_ids: ["BTC-USD"] }]
            }));
        };

        ws.onmessage = (e) => {
            const data = JSON.parse(e.data);
            if (data.type === 'ticker') {
                const newPrice = parseFloat(data.price);
                if (btcPrice > 0) {
                    // Trigger Barrier Events
                    if (Math.floor(newPrice/100) !== Math.floor(btcPrice/100)) effects.push(new PulsarWave());
                }
                lastPrice = btcPrice;
                btcPrice = newPrice;
                priceDisplay.innerText = `$${Math.floor(btcPrice).toLocaleString()}`;
                statusDisplay.innerText = "SIGNAL: COINBASE-WS LIVE";
            }

            // Real Order Book Depth
            if (data.type === 'snapshot') {
                asks = data.asks.slice(0, 10);
                bids = data.bids.slice(0, 10);
            }
            if (data.type === 'l2update') {
                // Simplified update for performance
                data.changes.forEach(change => {
                    const side = change[0], price = change[1], size = change[2];
                    if (side === 'sell') asks[0] = [price, size]; else bids[0] = [price, size];
                });
            }
        };
    }

    viewToggle.onclick = () => {
        currentView = currentView === 'singularity' ? 'radar' : 'singularity';
        viewToggle.innerText = currentView === 'singularity' ? 'GO TO RADAR' : 'GO TO CORE';
    };

    function render(time) {
        ctx.fillStyle = "#010208";
        ctx.fillRect(0, 0, RES_W, RES_H);

        // Stars
        stars.forEach(s => {
            s.x = (s.x - s.v + RES_W) % RES_W;
            ctx.fillStyle = "#333";
            ctx.fillRect(Math.floor(s.x), Math.floor(s.y), 1, 1);
        });

        if (btcPrice === 0) {
            ctx.fillStyle = "#5e43f3";
            ctx.fillText("CONNECTING TO FEED...", 140, 140);
        } else {
            const centerX = RES_W/2, centerY = RES_H/2;

            if (currentView === 'singularity') {
                // --- THE COMET TAIL ---
                trail.push({x: centerX, y: centerY + Math.sin(time/400)*15});
                if (trail.length > 25) trail.shift();
                trail.forEach((p, i) => {
                    ctx.strokeStyle = btcPrice >= lastPrice ? `rgba(0, 255, 136, ${i/25})` : `rgba(255, 68, 68, ${i/25})`;
                    ctx.lineWidth = i/3;
                    ctx.beginPath(); ctx.arc(p.x - (25-i)*5, p.y, i/5, 0, Math.PI*2); ctx.stroke();
                });

                // --- THE CORE ---
                const pulse = 25 + Math.sin(time/200)*5;
                const g = ctx.createRadialGradient(centerX, centerY, 2, centerX, centerY, pulse*1.8);
                g.addColorStop(0, "#fff");
                g.addColorStop(0.4, btcPrice >= lastPrice ? "#00ff88" : "#ff4444");
                g.addColorStop(1, "transparent");
                ctx.fillStyle = g;
                ctx.fillRect(centerX-100, centerY-100, 200, 200);
            } else {
                // --- LIVE RADAR (ORDER BOOK) ---
                const spreadGap = 20;
                asks.forEach((lvl, i) => {
                    const price = parseFloat(lvl[0]);
                    const vol = Math.min(20, parseFloat(lvl[1]) * 10);
                    const y = centerY - spreadGap - (i * 12) - (price - btcPrice);
                    ctx.fillStyle = "#ff4444";
                    ctx.fillRect(40 + (i*40), y, 10 + vol, 5); // Enemies size = Volume
                });
                bids.forEach((lvl, i) => {
                    const price = parseFloat(lvl[0]);
                    const vol = Math.min(20, parseFloat(lvl[1]) * 10);
                    const y = centerY + spreadGap + (i * 12) + (btcPrice - price);
                    ctx.fillStyle = "#00ff88";
                    ctx.fillRect(40 + (i*40), y, 10 + vol, 4); // Defenders size = Volume
                });
            }
        }

        effects = effects.filter(e => { e.update(); e.draw(); return e.life > 0; });
        requestAnimationFrame(render);
    }

    initLive();
    render();
</script>
</body>
</html>
