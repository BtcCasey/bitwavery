<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BTC COMMAND: MOTHERSHIP & SINGULARITY</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background: #010208; font-family: 'Press Start 2P', cursive; color: #fff; }
        #ui-main { position: absolute; top: 25px; left: 25px; z-index: 100; background: rgba(0,0,0,0.9); padding: 18px; border: 2px solid #5e43f3; box-shadow: 0 0 15px #5e43f3; pointer-events: none; }
        #view-toggle { position: absolute; top: 25px; right: 25px; z-index: 100; background: #5e43f3; color: #fff; border: 4px solid #fff; padding: 10px; cursor: pointer; font-family: 'Press Start 2P'; font-size: 10px; }
        #price { font-size: 18px; color: #fff; margin: 0; }
        #status { font-size: 7px; margin-top: 10px; color: #00ffcc; text-transform: uppercase; }
        canvas { display: block; image-rendering: pixelated; width: 100vw; height: 100vh; }
    </style>
</head>
<body>

<button id="view-toggle">GO TO RADAR</button>
<div id="ui-main">
    <div id="view-label" style="font-size: 8px; color: #5e43f3; margin-bottom: 8px;">SIGNAL: COINBASE-L2</div>
    <h1 id="price">SYNCING...</h1>
    <div id="status">ESTABLISHING SECURE LINK...</div>
</div>
<canvas id="screen"></canvas>

<script>
    const canvas = document.getElementById('screen');
    const ctx = canvas.getContext('2d');
    const priceDisplay = document.getElementById('price');
    const statusDisplay = document.getElementById('status');
    const viewToggle = document.getElementById('view-toggle');

    const RES_W = 480; const RES_H = 270;
    canvas.width = RES_W; canvas.height = RES_H;

    // --- STATE ---
    let currentView = 'singularity';
    let btcPrice = 0, startHourPrice = 0;
    let asks = [], bids = [], lasers = [];
    let history = []; // 60-minute price trail (scaled)
    let sentimentColor = {r: 255, g: 255, b: 255}; 
    let stars = Array.from({length: 40}, () => ({ x: Math.random()*RES_W, y: Math.random()*RES_H, v: 0.1+Math.random()*0.2 }));

    // --- HELPER: LERP ---
    const lerp = (a, b, t) => a + (b - a) * t;

    function drawMothership(x, y, color, isRed) {
        ctx.fillStyle = color;
        // Pixelated Hull
        ctx.fillRect(x-20, y, 40, 6); 
        ctx.fillRect(x-15, isRed ? y-4 : y+6, 30, 4);
        ctx.fillStyle = "#fff"; // Windows/Lights
        ctx.fillRect(x-10, y+2, 2, 2); ctx.fillRect(x+8, y+2, 2, 2);
    }

    // --- DATA ENGINE ---
    function init() {
        const ws = new WebSocket('wss://ws-feed.exchange.coinbase.com');
        ws.onopen = () => {
            ws.send(JSON.stringify({
                type: "subscribe",
                channels: ["ticker", "level2_batch", "matches"],
                product_ids: ["BTC-USD"]
            }));
        };

        ws.onmessage = (e) => {
            const data = JSON.parse(e.data);
            
            if (data.type === 'ticker') {
                btcPrice = parseFloat(data.price);
                if (!startHourPrice) startHourPrice = btcPrice;
                
                priceDisplay.innerText = `$${Math.floor(btcPrice).toLocaleString()}`;
                statusDisplay.innerText = "LINK STABLE";

                // Add to hourly history
                history.push(btcPrice);
                if (history.length > 300) history.shift();
            }

            if (data.type === 'snapshot') {
                asks = data.asks.slice(0, 10);
                bids = data.bids.slice(0, 10);
            }

            if (data.type === 'match') {
                lasers.push({
                    y: Math.random() * RES_H,
                    side: data.side, // 'buy' or 'sell'
                    life: 1.0,
                    size: parseFloat(data.size)
                });
            }
        };
    }

    viewToggle.onclick = () => {
        currentView = currentView === 'singularity' ? 'radar' : 'singularity';
        viewToggle.innerText = currentView === 'singularity' ? 'GO TO RADAR' : 'GO TO CORE';
    };

    function render(time) {
        ctx.fillStyle = "#010208";
        ctx.fillRect(0, 0, RES_W, RES_H);

        // Slow Background Stars
        stars.forEach(s => {
            s.x = (s.x - s.v + RES_W) % RES_W;
            ctx.fillStyle = "#222";
            ctx.fillRect(Math.floor(s.x), Math.floor(s.y), 1, 1);
        });

        if (btcPrice === 0) return requestAnimationFrame(render);

        // --- CALCULATE HOURLY SENTIMENT ---
        const diff = btcPrice - startHourPrice;
        const targetColor = diff >= 0 ? {r: 0, g: 255, b: 136} : {r: 255, g: 68, b: 68};
        sentimentColor.r = lerp(sentimentColor.r, targetColor.r, 0.05);
        sentimentColor.g = lerp(sentimentColor.g, targetColor.g, 0.05);
        sentimentColor.b = lerp(sentimentColor.b, targetColor.b, 0.05);
        const sCol = `rgb(${sentimentColor.r},${sentimentColor.g},${sentimentColor.b})`;

        const centerX = RES_W/2, centerY = RES_H/2;

        if (currentView === 'singularity') {
            // --- HOURLY COMET TRAIL ---
            ctx.beginPath();
            ctx.strokeStyle = sCol;
            ctx.globalAlpha = 0.4;
            ctx.lineWidth = 2;
            history.forEach((h, i) => {
                const tx = centerX - (history.length - i) * 2;
                const ty = centerY + (btcPrice - h) * 0.8; // Vertical movement based on price delta
                if (i === 0) ctx.moveTo(tx, ty); else ctx.lineTo(tx, ty);
            });
            ctx.stroke();
            ctx.globalAlpha = 1.0;

            // --- THE SINGULARITY ---
            const pulse = 25 + Math.sin(time/200)*5;
            const g = ctx.createRadialGradient(centerX, centerY, 2, centerX, centerY, pulse*1.8);
            g.addColorStop(0, "#fff");
            g.addColorStop(0.4, sCol);
            g.addColorStop(1, "transparent");
            ctx.fillStyle = g;
            ctx.fillRect(centerX-100, centerY-100, 200, 200);

        } else {
            // --- RADAR VIEW (MOTHERSHIPS) ---
            // Calculate mothership drift based on price pressure
            const drift = Math.sin(time/1000) * 20;
            
            // RED MOTHERSHIP (Sell Wall - Top)
            const redY = 40 + drift;
            drawMothership(centerX, redY, "#ff4444", true);
            
            // GREEN MOTHERSHIP (Buy Wall - Bottom)
            const greenY = RES_H - 40 - drift;
            drawMothership(centerX, greenY, "#00ff88", false);

            // Draw Order Book Levels between them
            asks.forEach((l, i) => {
                ctx.fillStyle = "rgba(255, 68, 68, 0.3)";
                ctx.fillRect(40 + i*40, redY + 15 + i*5, 15, 2);
            });
            bids.forEach((l, i) => {
                ctx.fillStyle = "rgba(0, 255, 136, 0.3)";
                ctx.fillRect(40 + i*40, greenY - 15 - i*5, 15, 2);
            });
        }

        // --- HORIZONTAL LASERS (TRADE MATCHES) ---
        lasers = lasers.filter(l => {
            ctx.strokeStyle = l.side === 'buy' ? `rgba(0, 255, 136, ${l.life})` : `rgba(255, 68, 68, ${l.life})`;
            ctx.lineWidth = Math.min(4, l.size * 10);
            const y = l.y;
            ctx.beginPath();
            if (l.side === 'buy') { // Shoots from Green (Bottom) toward Top
                ctx.moveTo(centerX, RES_H - 40); ctx.lineTo(l.x || (Math.random()*RES_W), y);
            } else { // Shoots from Red (Top) toward Bottom
                ctx.moveTo(centerX, 40); ctx.lineTo(l.x || (Math.random()*RES_W), y);
            }
            ctx.stroke();
            l.life -= 0.04;
            return l.life > 0;
        });

        requestAnimationFrame(render);
    }

    init();
    render();
</script>
</body>
</html>
