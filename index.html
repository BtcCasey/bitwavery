<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BTC SOVEREIGN: HIGH-DPI VORTEX</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Orbitron', sans-serif; color: #fff; }
        #ui-main { position: absolute; top: 40px; left: 40px; z-index: 100; padding: 20px; border-left: 2px solid #fff; pointer-events: none; backdrop-filter: blur(8px); }
        #view-toggle { position: absolute; top: 40px; right: 40px; z-index: 100; background: none; color: #fff; border: 1px solid #fff; padding: 12px 24px; cursor: pointer; font-family: 'Orbitron'; font-size: 10px; text-transform: uppercase; transition: 0.2s; }
        #view-toggle:hover { background: #fff; color: #000; }
        #price { font-size: 28px; font-weight: 700; margin: 0; text-shadow: 0 0 20px rgba(255,255,255,0.3); }
        canvas { display: block; width: 100vw; height: 100vh; }
    </style>
</head>
<body>

<button id="view-toggle">Switch to Battlefield</button>
<div id="ui-main">
    <div id="price">LOADING...</div>
    <div id="status" style="font-size: 10px; color: #777; margin-top: 5px;">32-BIT VORTEX SYNCED</div>
</div>
<canvas id="screen"></canvas>

<script>
    const canvas = document.getElementById('screen');
    const ctx = canvas.getContext('2d');
    const priceDisplay = document.getElementById('price');
    
    // High-DPI Canvas Scaling
    function resize() {
        const dpr = window.devicePixelRatio || 1;
        canvas.width = window.innerWidth * dpr;
        canvas.height = window.innerHeight * dpr;
        ctx.scale(dpr, dpr);
    }
    window.addEventListener('resize', resize);
    resize();

    let currentView = 'singularity';
    let btcPrice = 0, startDayPrice = 0;
    let stars = [], ships = [], explosions = [];
    let rotation = 0;

    async function init() {
        const stats = await fetch('https://api.exchange.coinbase.com/products/BTC-USD/stats').then(r => r.json());
        startDayPrice = parseFloat(stats.open);
        
        const candles = await fetch('https://api.exchange.coinbase.com/products/BTC-USD/candles?granularity=300').then(r => r.json());
        const prices = candles.map(c => c[4]).reverse();
        const minP = Math.min(...prices), maxP = Math.max(...prices);

        // Map stars to price with DRAMATIC amplitude
        stars = prices.map((p, i) => {
            const priceVariance = (p - minP) / (maxP - minP);
            return {
                angle: i * 0.15,
                baseDist: 40 + (i * 1.5),
                variance: priceVariance * 180, // Dramatically boosted
                size: Math.random() * 2 + 1,
                alpha: 0.1 + Math.random() * 0.5
            };
        });

        const ws = new WebSocket('wss://ws-feed.exchange.coinbase.com');
        ws.onopen = () => ws.send(JSON.stringify({ type: "subscribe", channels: ["ticker", "matches"], product_ids: ["BTC-USD"] }));
        ws.onmessage = (e) => {
            const data = JSON.parse(e.data);
            if (data.type === 'ticker') {
                btcPrice = parseFloat(data.price);
                priceDisplay.innerText = `$${btcPrice.toLocaleString()}`;
            }
            if (data.type === 'match' && currentView === 'battle') {
                ships.push({
                    x: Math.random() * window.innerWidth,
                    y: data.side === 'buy' ? window.innerHeight + 50 : -50,
                    side: data.side,
                    v: 3 + Math.random() * 4,
                    size: 2 + (parseFloat(data.size) * 30)
                });
            }
        };
    }

    function drawSaturn(cx, cy, color) {
        // Core Singularity
        const g = ctx.createRadialGradient(cx, cy, 0, cx, cy, 40);
        g.addColorStop(0, '#fff');
        g.addColorStop(1, 'transparent');
        ctx.fillStyle = g;
        ctx.beginPath(); ctx.arc(cx, cy, 40, 0, Math.PI * 2); ctx.fill();

        // High-Fidelity Saturn Rings
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(Math.PI / 10); // Tilt
        
        ctx.lineWidth = 1.5;
        // Draw 3 concentric ring layers for 32-bit depth
        for (let i = 0; i < 3; i++) {
            ctx.strokeStyle = `rgba(255, 255, 255, ${0.1 + (i * 0.1)})`;
            ctx.beginPath();
            ctx.ellipse(0, 0, 85 + (i * 10), 25 + (i * 3), 0, 0, Math.PI * 2);
            ctx.stroke();
        }
        ctx.restore();
    }

    function render(time) {
        ctx.fillStyle = '#020205';
        ctx.fillRect(0, 0, window.innerWidth, window.innerHeight);
        if (btcPrice === 0) return requestAnimationFrame(render);

        const cx = window.innerWidth / 2;
        const cy = window.innerHeight / 2;
        rotation += 0.0015; // Slow, majestic spin

        const themeColor = btcPrice >= startDayPrice ? '64, 255, 180' : '255, 80, 80';

        // 1. Draw Spiral (Price Action Map)
        stars.forEach(s => {
            const a = s.angle + rotation;
            const dist = s.baseDist + s.variance;
            const x = cx + Math.cos(a) * dist * 1.8;
            const y = cy + Math.sin(a) * dist * 0.8;

            ctx.fillStyle = `rgba(${themeColor}, ${s.alpha})`;
            ctx.beginPath();
            ctx.arc(x, y, s.size, 0, Math.PI * 2);
            ctx.fill();
        });

        if (currentView === 'singularity') {
            drawSaturn(cx, cy, themeColor);
        } else {
            // 2. Draw Battlefield Laser & Ships
            const midY = window.innerHeight / 2;
            
            // Neon Laser Core
            ctx.shadowBlur = 15;
            ctx.shadowColor = `rgb(${themeColor})`;
            ctx.strokeStyle = `rgba(${themeColor}, 0.8)`;
            ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(0, midY); ctx.lineTo(window.innerWidth, midY); ctx.stroke();
            ctx.shadowBlur = 0;

            ships = ships.filter(s => {
                ctx.fillStyle = s.side === 'buy' ? '#40ffb4' : '#ff5050';
                ctx.fillRect(s.x, s.y, s.size, s.size * 2);
                s.y += s.side === 'buy' ? -s.v : s.v;

                if (Math.abs(s.y - midY) < 10) {
                    for(let i=0; i<15; i++) {
                        explosions.push({
                            x: s.x, y: midY,
                            vx: (Math.random()-0.5) * 12,
                            vy: (Math.random()-0.5) * 12,
                            life: 1.0, color: ctx.fillStyle
                        });
                    }
                    return false;
                }
                return s.y > -100 && s.y < window.innerHeight + 100;
            });

            explosions = explosions.filter(e => {
                ctx.globalAlpha = e.life;
                ctx.fillStyle = e.color;
                ctx.beginPath(); ctx.arc(e.x, e.y, 2, 0, Math.PI*2); ctx.fill();
                e.x += e.vx; e.y += e.vy; e.life -= 0.025;
                return e.life > 0;
            });
            ctx.globalAlpha = 1;
        }

        requestAnimationFrame(render);
    }

    document.getElementById('view-toggle').onclick = () => {
        currentView = currentView === 'singularity' ? 'battle' : 'singularity';
        document.getElementById('view-toggle').innerText = currentView === 'singularity' ? 'Switch to Battlefield' : 'Switch to Core';
    };

    init();
    render();
</script>
</body>
</html>
